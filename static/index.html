<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Poem2Park</title>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 860px;
      margin: 40px auto;
      padding: 0 16px;
    }

    textarea {
      width: 100%;
      height: 220px;
      font-size: 16px;
      padding: 10px;
      box-sizing: border-box;
    }

    button {
      margin-top: 10px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }

    h1 {
      margin-bottom: 6px;
    }

    h2 {
      margin-bottom: 6px;
    }

    .section {
      margin-top: 26px;
    }

    .box {
      background: #f6f6f6;
      border-radius: 12px;
      padding: 14px;
      margin-top: 8px;
    }

    ol {
      margin: 6px 0 0 22px;
    }

    .muted {
      color: #666;
      font-size: 14px;
    }

    .poem {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 15px;
    }

    .hl {
      background: #c9f3c9;
      border-radius: 4px;
      padding: 1px 3px;
    }

    .conn {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    #parkTitle {
      margin-top: 22px;
      margin-bottom: 6px;
      text-align: center;
      font-size: 26px;
      font-weight: 500;
      letter-spacing: 0.08em;
      display: none;
    }

    #parkImg {
      width: 100%;
      max-height: 360px;
      object-fit: cover;
      border-radius: 12px;
      display: none;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <h1>Poem2Park</h1>
  <p class="muted">
    Paste a poem to see which California national park it most resembles.
  </p>

  <textarea id="poem" placeholder="Paste your poem here..."></textarea>
  <br>
  <button id="go">Match</button>

  <!-- Park title + image -->
  <h2 id="parkTitle"></h2>
  <img id="parkImg" src="" alt="">

  <!-- Results -->
  <div id="out" style="display:none;"></div>

  <!-- ===================== -->
  <!-- JavaScript logic -->
  <!-- ===================== -->
  <script>
    const out = document.getElementById("out");
    const poemBox = document.getElementById("poem");
    const img = document.getElementById("parkImg");
    const title = document.getElementById("parkTitle");

    function esc(s) {
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function fmt(n) {
      return Number(n).toFixed(3);
    }

    function highlightPoem(poem, phrases) {
      let html = esc(poem);

      phrases
        .sort((a, b) => b.length - a.length)
        .forEach(p => {
          const safe = p.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const re = new RegExp(`\\b(${safe})\\b`, "gi");
          html = html.replace(re, `<span class="hl">$1</span>`);
        });

      return html;
    }

    document.getElementById("go").addEventListener("click", async () => {
      const poem = poemBox.value.trim();
      if (!poem) return;

      out.style.display = "block";
      out.innerHTML = "<div class='box'>Running…</div>";

      title.style.display = "none";
      img.style.display = "none";

      try {
        const res = await fetch("/match", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ poem })
        });

        const data = await res.json();

        if (data.error) {
          out.innerHTML = `<div class="box"><b>Error:</b> ${esc(data.error)}</div>`;
          return;
        }

        /* ---------- TITLE + IMAGE ---------- */
        if (data.image_url) {
          title.textContent = `${data.best_park.toUpperCase()} NATIONAL PARK`;
          title.style.display = "block";

          img.src = data.image_url;
          img.alt = data.best_park;
          img.style.display = "block";
        }

        /* ---------- DATA ---------- */
        const parks = data.ranked_parks || [];
        const biomes = data.biomes || [];
        const bestPark = data.best_park;
        const connections = (data.explanations || {})[bestPark] || [];

        const phrases = connections.map(c => c.poem_unit.toLowerCase());

        const parkList = parks.map(
          ([p, s]) => `<li>${esc(p)} (${fmt(s)})</li>`
        ).join("");

        const biomeList = biomes.map(
          ([b, s]) => `<li>${esc(b)} (${fmt(s)})</li>`
        ).join("");

        const highlightedPoem = highlightPoem(poem, phrases);

        const connText = connections.map(c =>
          `${c.poem_unit} (${c.poem_unit_type}) → ${c.matched_park_unit} ` +
          `[sim=${Number(c.similarity).toFixed(2)}, vote=${Number(c.gated_vote).toFixed(2)}]`
        ).join("\n");

        /* ---------- RENDER ---------- */
        out.innerHTML = `
          <div class="section">
            <h2>Best Match:</h2>
            <div class="box">
              <ol>${parkList || "<li>(none)</li>"}</ol>
            </div>
          </div>

          <div class="section">
            <h2>Top Biomes:</h2>
            <div class="box">
              <ol>${biomeList || "<li>(none)</li>"}</ol>
            </div>
          </div>

          <div class="section">
            <h2>Highlighted Poem (Contributing Words)</h2>
            <div class="box poem">${highlightedPoem}</div>
          </div>

          <div class="section">
            <h2>Word Connections (Best Park):</h2>
            <div class="box conn">
              ${esc(connText || "(no strong connections)")}
            </div>
          </div>
        `;
      } catch (e) {
        out.innerHTML = `<div class="box"><b>Request failed:</b> ${esc(e)}</div>`;
      }
    });
  </script>
</body>
</html>